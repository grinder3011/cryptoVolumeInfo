<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Volume Momentum Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white p-6">
  <h1 class="text-3xl font-bold mb-6">ðŸ“Š Crypto Volume Momentum Monitor</h1>
  
  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="border-b border-gray-700 text-gray-300">
          <th class="p-2">Coin</th>
          <th class="p-2">Price</th>
          <th class="p-2">24h Volume</th>
          <th class="p-2 text-yellow-400">Volume Î” (24h)</th>
          <th class="p-2">Trend (7d)</th>
        </tr>
      </thead>
      <tbody id="coin-table"></tbody>
    </table>
  </div>

  <!-- Detailed Chart -->
  <div class="mt-8">
    <h2 class="text-2xl mb-2" id="chartTitle">Click a coin row to see detailed volume</h2>
    <canvas id="detailChart" class="bg-gray-800 p-4 rounded-lg shadow-md"></canvas>
  </div>

  <script>
    async function fetchCoins() {
      const url = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=volume_desc&per_page=100&page=1&sparkline=false";
      const res = await fetch(url);
      return res.json();
    }

    async function fetchVolumeHistory(coinId, days=2) {
      const url = `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${days}`;
      const res = await fetch(url);
      return res.json();
    }

    function formatNumber(num) {
      return new Intl.NumberFormat("en-US", {notation: "compact"}).format(num);
    }

    let detailChart;

    async function renderTable() {
      const coins = await fetchCoins();
      const table = document.getElementById("coin-table");
      table.innerHTML = "";

      for (const coin of coins) {
        // Get 48h of volume for change calc
        const history = await fetchVolumeHistory(coin.id, 2);
        const volumes = history.total_volumes.map(v => v[1]);
        const labels = history.total_volumes.map(v => new Date(v[0]).toLocaleDateString());

        // Split into two 24h windows
        const half = Math.floor(volumes.length / 2);
        const prev24h = volumes.slice(0, half).reduce((a, b) => a + b, 0);
        const curr24h = volumes.slice(half).reduce((a, b) => a + b, 0);

        let volumeChangePct = ((curr24h - prev24h) / prev24h) * 100;

        // Build sparkline
        const sparkCanvas = document.createElement("canvas");
        sparkCanvas.width = 100;
        sparkCanvas.height = 30;

        new Chart(sparkCanvas, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              data: volumes,
              borderColor: "cyan",
              borderWidth: 1,
              pointRadius: 0,
              fill: false,
              tension: 0.2
            }]
          },
          options: {
            responsive: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { display: false }
            }
          }
        });

        // Table row
        const row = document.createElement("tr");
        row.className = "border-b border-gray-800 hover:bg-gray-800 cursor-pointer";
        
        row.innerHTML = `
          <td class="p-2 flex items-center gap-2">
            <img src="${coin.image}" class="w-6 h-6"> ${coin.name} (${coin.symbol.toUpperCase()})
          </td>
          <td class="p-2">$${coin.current_price.toLocaleString()}</td>
          <td class="p-2">$${formatNumber(curr24h)}</td>
          <td class="p-2 font-bold ${
            volumeChangePct > 0 ? "text-green-400" : "text-red-400"
          }">${volumeChangePct.toFixed(1)}%</td>
        `;

        // Append sparkline
        const sparkTd = document.createElement("td");
        sparkTd.className = "p-2";
        sparkTd.appendChild(sparkCanvas);
        row.appendChild(sparkTd);

        // On click â†’ detailed chart
        row.addEventListener("click", () => {
          document.getElementById("chartTitle").innerText = `${coin.name} Volume (7d)`;
          if (detailChart) detailChart.destroy();

          fetchVolumeHistory(coin.id, 7).then(history7d => {
            const vols7d = history7d.total_volumes.map(v => v[1]);
            const labels7d = history7d.total_volumes.map(v => new Date(v[0]).toLocaleDateString());
            const ctx = document.getElementById("detailChart").getContext("2d");

            detailChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels7d,
                datasets: [{
                  label: "Volume (USD)",
                  data: vols7d,
                  borderColor: "cyan",
                  fill: false,
                  tension: 0.2
                }]
              },
              options: {
                plugins: { legend: { labels: { color: "white" } } },
                scales: {
                  x: { ticks: { color: "white" } },
                  y: { ticks: { color: "white" } }
                }
              }
            });
          });
        });

        table.appendChild(row);
      }
    }

    renderTable();
  </script>
</body>
</html>
